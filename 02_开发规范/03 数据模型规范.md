# 一、背景

# 二、依据

# 三、设计原则
数据模型遵循以下设计原则：
- 高内聚和低耦合：一个逻辑和物理模型中的记录和字段组成，应该遵循最基本的软件设计方法论中的高内聚和低耦合原则。主要从数据业务特性和访问特性两个角度来考虑：
  - 将业务相近或者相关的数据、粒度相同数据设计为一个逻辑或者物理模型。
  - 将高概率同时访问的数据放一起，将低概率同时访问的数据分开存储。
- 核心模型与扩展模型分离：建立核心模型与扩展模型体系，核心模型包括的字段支持常用核心的业务，扩展模型包括的字段支持个性化或是少量应用的需要。当核心模型与扩展模型进行关联时，不能让扩展字段过度侵入核心模型，以免破坏了核心模型的架构简洁性与可维护性。
- 公共处理逻辑下沉及单一：底层公用的处理逻辑应该在数据调度依赖的底层进行封装与实现，不能让公用的处理逻辑暴露给应用层实现，不能让公共逻辑在多处同时存在。
- 成本与性能平衡：适当的数据冗余可换取查询和刷新的性能，但不宜过度冗余与数据复制。
- 数据可回滚：处理逻辑不变，在不同时间多次运行数据的结果需确定不变。
- 一致性：相同的字段在不同表中的字段名必须相同。
- 命名清晰可理解：表命名规范需清晰、一致，表命名需易于下游的理解和使用。
# 四、建设流程
数据模型建设整体流程，从上游接收到指标的需求开始，围绕着梳理业务及数据、规范定义、模型建设、模型优化、资产管理及应用，共5个步骤出发
![img](/static/数据开发流程.png)

## 4.1 梳理业务及数据
### 4.1.1 数据调研
充分了解所建设板块的业务流程，对于数仓建设来说，是为了明确：
- 各个系统主要的功能以及能够获取到的数据，eg：电商平台上用户的访问/浏览埋点数据、注册数据、下单数据
- 各个业务模块之间的关系、及数据流动，eg：电商中，从访问、加购、下单、发货、签收等完整的业务流程，他们的数据之间存在的关系

---
### 4.1.2 主题域的划分
根据业务需求和逻辑关系将数据划分为几个逻辑相关的区域或类别的过程。
eg：电商中会将数据划分为：
- 销售：和销售有关的事实表和维度表(销售事实表、产品维度表、门店维度表)
- 库存：与库存有关的数据(库存变动表)
- 客户：设计客户信息有关的数据(客户维度表、客户偏好行为分析表)
……
主题域的作用是联系较为紧密的数据主题的集合，是业务对象高度概括的概念层次归类，目的是便于数据的管理和应用。
主题域划分的方式多种多样：
- 业务过程(主要方式)
- 用户和利益相关人：eg：职能部门
- 按功能划分：这个和业务过程会有重合的地方
……

## 4.2 规范定义
### 4.2.1 构建总线矩阵
总线矩阵由Ralph Kimball提出的，是维度建模方法论的一部分。
总线矩阵由两个主要部分组成：
- 行：表示一致性的维度(不同业务过程之间共性较高的维度)
- 列：表示不同的主题域和业务过程
- 矩阵的交叉点：(除了Y也可以用√)标明了哪些维度与哪些业务过程相关联。
以电商交易主题域，举个例子
第一行数据可以看出，下单这个业务流程存在着购买省份、购买城市、时间、商品。总线矩阵的作用，就可以方便我们通过总线矩阵来设计指标，比如说 30天内福建省的下单记录


### 4.2.2 明确统计指标
统计指标有多种多样，要先和业务或者上游确认好指标的定义、指标的级别和维度、更新的频率等等
- 指标的定义：了解业务部门的对指标的定义，避免口径不一致导致错误。eg：人员画像里年龄划分，有的人觉得35-50为中年人，有的认为30-50为中年。
- 指标的维度和粒度级别：
  确认指标的统计粒度，是按什么维度(时间周期/地区/记录数)统计，周期就是按(年/月/日/小时)等，统计周期越小，统计粒度越细，周期越大，统计粒度越粗。粗的统计粒度用来展示整体的情况，细的统计粒度用来展示具体。
  指标统计还涉及到度量，度量指的是用什么单位，比如重量有公制的千克和英制的英镑。
指标的分类：
- 原子指标：最基本的度量，反应业务事件的行为。eg：支付金额，用户数量
- 派生指标：通过计算或者加工原子指标得到的，通常涉及多个原子指标的组合。eg：平均每笔交易、30天内的用户注册总数
- 衍生指标：基于原子指标或者派生指标组合构建。eg：客单价通过支付金额除以买家数组合而来。

## 4.3 模型建设
整个数仓结构划分为下图：
![img](/static/数仓分层图.png)

各层的作用
- ODS层(ODS，Operational Data Store)：将原始数据几乎无处理地存放在数据仓库系统中，结构上与源系统基本保持一致，是数据仓库的数据准备区。
- 数据公共层（CDM，Common Dimensions Model）：存放明细事实数据、维表数据及公共指标汇总数据。其中，明细事实数据、维表数据一般根据ODS层数据加工生成。公共指标汇总数据一般根据维表数据和明细事实数据加工生成
  - 维度层（DIM，Dimension）：负责管理维度数据，这些数据用于对DWD层的事实数据进行描述和分类。详细内容可以见下方00 数仓建设知识体系。
  - 明细数据层（DWD，Data Warehouse Detail）：负责存储经过清洗和转换后的事实数据，为后续的汇总和分析提供基础数据。详细内容可以见下方00 数仓建设知识体系。
  - 汇总数据层（DWS，Data Warehouse Summary）：以分析的主题对象作为建模驱动，基于上层的应用和产品的指标需求，构建公共粒度的汇总指标表。以宽表化手段物理化模型，构建命名规范、口径一致的统计指标，为上层提供公共指标，建立汇总宽表、明细事实表。用于存放派生指标数据。
- 数据应用层（ADS，Application Data Store）：存放数据产品个性化的统计指标数据，根据CDM层加工生成。

这层主要是对CDM层(数据公共层)内容的建设。模型建设中主要有构建明细模型和构建汇总模型两方面。

### 4.3.1 构建明细模型
明细模型根据不同的主题域出发，对维度层（DIM）和明细数据层（DWD）进行建设。
DIM层负责对维度表的建设，eg：产品的分类维度表
```
有些情况下维度表内容会随时间变化进行更新，kimball 提出的 缓慢变化维(BCD) 就是为了管理维度的技术，共有 8 种，实际使用中主要有以下 3 种：
1. 直接覆盖：只保留最新 (适用于不需要跟踪历史数据或历史数据变化)
2. 行版本控制：用额外的列(开始时间、结束时间、版本号等)标识不同版本记录，拉链表就是其中一种方法，使用开始时间和结束时间来管理行的记录。
3. 新增列保留历史：新增列来记录历史记录，通常包含“原始值”和“当前值”，适用于跟踪有限历史变化，比如最近一次的历史记录
```
DWD层主要负责：
1. 数据清洗：清洗数据以消除质量问题，如去除重复项、纠正错误数据和填补缺失值，
2. 数据转换：转换数据以满足DWD层的模式要求，主要和维度表关联保持数据格式的统一，也就是所说的 维度退化
3. 建立事实表：根据需求，确定事实表的类型和粒度，类型参考以下：

### 4.3.2 构建汇总模型
明确完统计指标以后，设计满足业务分析需求的汇总模型，主要流程有：
1. 设计汇总表的结构，比如说：

2. 设计数据抽取的逻辑，也就是DWD到DWS的过程，离线可以使用Hive SQL或者Spark，实时使用Flink，编写任务，然后提交给调度系统进行。


## 4.4 模型优化
- 查询优化：通过物理设计(索引、分区、分桶(Hive))，和查询优化(建立物化视图：能够存储查询数据的一种特殊视图)
- 数据倾斜优化：通过合理的数据分布和调整任务并行度来减少数据倾斜，减少数据加载处理时间
- 调整存储格式：调整存储格式为列式存储(如Parquet、ORC等)，来减少磁盘IO


## 4.5 结果验证&应用
结果验证可以通过以下方式进行：
- 样本验证：随机取样检查
- 数据的一致性检查：处理前后的总体指标，如记录数、总和、平均值
- 逻辑验证：常识性检查，例如销售额不可能为复数、年龄不应该超过常规年龄范围
- 历史数据对比：将当前的数据处理结果与历史记录或已知的正确结果进行比较
- ……

在ADS层(应用层)的数据通常是从DWS(数据仓库汇总层)进一步加工、汇总和优化后得来，以便直接支持业务决策、报表生成和数据分析应用。eg：电商平台的月度销售报表

ADS和DWS的区别点：
  - DWS层的表可能仍然保持一定的通用性，以便于支持多种分析路径和查询模式。数据虽然经过汇总，但仍保留了一定的细节，以便进行深入分析。
  - ADS层的表则更注重于特定分析任务的需求，往往包含了为了提升性能而预先计算好的指标和汇总数据。例如，如果一个报表需要展示每个月的总销售额、总利润和平均订单金额，ADS层的表将直接包含这些指标，以减少实时计算的需要。

# 五、开发规范
## 5.1 层级调用规范
  主要分为稳定业务和非稳定业务：
  - 稳定业务：按照标准的数据流向进行开发，即 ODS –> DWD –> DWS –> ADS
  - 非稳定业务或探索性需求：可以遵循 ODS -> DWD -> ADS
注意事项：
- DWS 和 ADS 中禁止直接使用 ODS 的表， ODS 的表只能被 DWD 引用
- 禁止出现反向依赖，例如 DWD 的表依赖 DWS 的表
## 5.2 数据类型规范
CDM数据公共层对ODS的清洗加工，按照统一规定的不同数据的数据类型严格执行：
  - 金额：double 或使用 decimal(28,6) 控制精度等，明确单位是分还是元。
  - 字符串：string。
  - id类：bigint。
  - 时间：string。
  - 状态：string
## 5.3 数据冗余规范
一个表做宽表冗余维度属性时，应该遵循以下建议准则：
- 冗余字段与表中其它字段高频率（大于3个下游应用SQL）同时访问。
- 冗余字段的引入不应造成其本身的刷新完成时间产生过多后延。
- 公共层数据不允许字段重复率大于60%的相同粒度数据表冗余，可以选择在原表基础上拓宽或者在下游应用中通过JOIN方式实现。
## 5.4 空值处理规范
汇总类指标的空值：空值处理，填充为零，
维度属性值为空：在汇总到对应维度上时，对于无法对应的统计事实，记录行会填充为-99（未知），对应维表会出现一条-99（未知）的记录。
## 5.5 生命周期规范
等级划分
将历史数据划分P0、Pl、P2、P3 四个等级，各个等级描述如下：
- P0 ：非常重要的主题域数据和非常重要的应用数据，具有不可恢复性，如交易、日志、集团 KPI 数据、 IPO 关联表。
- P1：重要的业务数据和重要的应用数据，具有不可恢复性，如重要的业务产品数据。
- P2 ：重要的业务数据和重要的应用数据，具有可恢复性，如交易线 ETL 产生的中间过程数据。
- P3 ：不重要的业务数据和不重要的应用数据，具有可恢复性，如某些 产品报表。

---
类型划分
- 事实表：数据无重复或者无主键数据，如日志。
- 维度表：包括维度与维度属性数据，如用户表、商品表。
- 临时表：处理过程中产生的临时表数据。
- 统计表：对数据进行汇聚、统计得出的分析结果。
结合上述的划分规则，得出表的生命周期管理规则如下

## 5.5 表命名规范
术语规范：
- 数据域(主题域)：数据域(主题域)是联系较为紧密的数据主题的集合，是业务对象高度概括的概念层次归类。
- 业务过程：根据实际业务过程进行归纳、抽象得出的，不清楚或没有写 detail
(以上两个见主题域设计02 架构、数仓、数据标准)
- 保存周期：数据保留的时间范围，对应年月日，例如：30天写30d，3年写3y，1个月写1m，永久的写forever
- 全量或增量：full 为全量数据，inc 为增量数据
- 统计粒度/统计维度：统计汇聚时，使用的维度，例如：按创建时间写createtime；与字段名相关。
- 统计周期：选择统计维度周期粒度，例如：时间按30天写30d、按3年写3y。

ods层 & dwd 层
ods/dwd_<数据域>_<业务过程>_<保存周期>_<全量/增量>
eg: ods_platformlogs_externaltts_forever_full

dws 层
dws_<数据域>_<业务过程>_<统计粒度/统计维度>_<周期粒度>
eg:dws_ platformlogs_externaltts_createtime_1d
## 5.6 字段命名规范

# 参考文献
- 《大数据之路：阿里巴巴大数据实践》
- 《数仓工具箱：维度建模权威指南》
- 《OneData建设：美团SaaS数仓建设》